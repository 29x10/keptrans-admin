Erp=Ember.Application.create();Erp.ApplicationAdapter=DS.ActiveModelAdapter.extend({host:"http://api.keptrans.com"});Erp.ApplicationSerializer=DS.RESTSerializer.extend({primaryKey:"_id"});Erp.Router.reopen({location:"history"});Ember.LinkView.reopen({closeSideBar:false,_invoke:function(b){var a=this._super(b);var c=this.get("closeSideBar");if(c){Ember.$(".ui.sidebar").sidebar({overlay:true}).sidebar("hide")}return a}});Erp.FormDataPromise={ajax:function(b,c,e,d,f){var a=this;return new Ember.RSVP.Promise(function(h,g){f=a.ajaxOptions(b,c,e,d,f);f.success=function(i){Ember.run(null,h,i)};f.error=function(i){Ember.run(null,g,a.ajaxError(i))};Ember.$.ajax(f)})},ajaxError:function(a){if(a){a.then=null}return a},ajaxOptions:function(a,b,d,c,e){e=e||{};e.url=a;e.type=b;e.crossDomain=c;e.data=d;return e}};Erp.ProductMaster=DS.Model.extend({brand:DS.attr("string"),tags:DS.hasMany("productTag"),category:DS.attr("string"),desc:DS.attr("string")});Erp.ProductTag=DS.Model.extend({name:DS.attr("string"),master:DS.belongsTo("productMaster")});Erp.ProductImage=DS.Model.extend({url:DS.attr("string"),master:DS.belongsTo("productMaster")});Erp.Product=DS.Model.extend({brand:DS.attr("string"),price:DS.attr("string"),deadline:DS.attr("string"),unit:DS.attr("string"),pattern:DS.attr("string"),sku:DS.attr("string")});Erp.FormInputView=Ember.TextField.extend({attributeBindings:["type","value","size","pattern","name","min","max","accept","autocomplete","autosave","formaction","formenctype","formmethod","formnovalidate","formtarget","height","inputmode","list","multiple","pattern","step","width","error","regex"],name:"default",error:"",regex:"^.+$",hasError:false,getFocus:false,valueChanged:function(){re=new RegExp(this.get("regex"),"g");this.set("error",!re.test(this.get("value"))&&this.get("getFocus"))}.observes("value","getFocus"),focusIn:function(a){this._super(a);this.set("getFocus",true)},focusOut:function(a){this._super(a);this.set("getFocus",false)}});Ember.Handlebars.helper("form-input",Erp.FormInputView);Erp.ImageUploadView=Ember.TextField.extend({type:"file",classNames:["hidden"],attributeBindings:["type","value","size","pattern","name","min","max","accept","autocomplete","autosave","formaction","formenctype","formmethod","formnovalidate","formtarget","height","inputmode","list","multiple","pattern","step","width","file"],change:function(b){var a=this.get("element").files[0];this.set("file",a)},file:""});Ember.Handlebars.helper("img-upload",Erp.ImageUploadView);Erp.MultiImageUploadView=Ember.TextField.extend({type:"file",classNames:["hidden"],multiple:"multiple",attributeBindings:["type","value","size","pattern","name","min","max","accept","autocomplete","autosave","formaction","formenctype","formmethod","formnovalidate","formtarget","height","inputmode","list","multiple","pattern","step","width","files"],change:function(d){var c=this.get("files");var b=this.get("element").files;for(var a=0;a<b.length;a++){c.pushObject(this.get("element").files[a])}},files:Ember.A()});Ember.Handlebars.helper("multi-img-upload",Erp.MultiImageUploadView);Erp.ImagePreviewView=Ember.View.extend({tagName:"img",attributeBindings:["src","file"],classNames:["ui","image"],src:"",file:"",willInsertElement:function(){var a=new FileReader();a.onload=function(b){this.set("src",b.target.result)}.bind(this);a.readAsDataURL(this.get("file"))},fileChanged:function(){this.get("controller").set("barWidth","width: 0");this.get("controller").set("uploadStatus","上传");this.get("controller").set("startUpload",false);var a=new FileReader();a.onload=function(b){this.set("src",b.target.result)}.bind(this);a.readAsDataURL(this.get("file"))}.observes("file")});Ember.Handlebars.helper("img-preview",Erp.ImagePreviewView);Erp.ItemView=Ember.View.extend({didInsertElement:function(){this.get("controller").set("index",this.get("contentIndex"))}});Ember.Handlebars.helper("price",function(b,a){b=""+b;return b.slice(0,-2)+"."+b.slice(-2)});Erp.TagsAddComponent=Ember.Component.extend({tagName:"",tags:Ember.A(),actions:{addTag:function(){var c=this.get("tagValue");if(c){var b=this.get("targetObject.store");var a=b.createRecord("product-tag",{name:c}).then(function(d){console.log(d)},function(d){console.log(d)});this.get("tags").pushObject({name:c});this.set("tagValue","")}},removeTag:function(a){this.get("tags").removeObject(a)}}});Erp.ZeroClipboardComponent=Ember.Component.extend({didInsertElement:function(){var a=new ZeroClipboard(this.$(".ui.button"))}});Erp.FormFieldComponent=Ember.Component.extend({tagName:"",error:false,label:"默认标签",placeholder:"请输入...",regex:"^.+$",icon:"reorder",value:"",errorMessage:"出错了..."});Erp.ImageUploadComponent=Ember.Component.extend({barWidth:"width: 0;",startUpload:false,uploadStatus:"上传",imageUrl:"",imageObject:false,actions:{uploadImage:function(b){var d=new FormData();var a=this;if(a.get("startUpload")){return}d.append("file",b);var c={xhr:function(){var e=Ember.$.ajaxSettings.xhr();e.upload.onprogress=function(g){var f="width: "+g.loaded/g.total*100+"%";a.set("barWidth",f)};e.onload=function(f){a.set("barWidth","width: 100%")};return e},contentType:false,processData:false};a.set("startUpload",true);a.set("uploadStatus","上传中");Erp.FormDataPromise.ajax("http://api.keptrans.com/image","POST",d,true,c).then(function(e){a.set("uploadStatus","上传完成");a.set("imageUrl","http://keptrans.b0.upaiyun.com"+e.image);console.log(e)},function(e){a.set("startUpload",false);a.set("uploadStatus","上传");a.set("barWidth","width: 0");console.log(e)})},chooseImage:function(){this.$("input").trigger("click")}}});Erp.ImagesListComponent=Ember.Component.extend({barWidth:"width: 0;",uploadStatus:"上传",startUpload:false,imageUrl:"",actions:{upload:function(b){var d=new FormData();var a=this;if(a.get("startUpload")){return}d.append("file",b);var c={xhr:function(){var e=Ember.$.ajaxSettings.xhr();e.upload.onprogress=function(g){var f="width: "+g.loaded/g.total*100+"%";a.set("barWidth",f)};e.onload=function(f){a.set("barWidth","width: 100%")};return e},contentType:false,processData:false};a.set("startUpload",true);a.set("uploadStatus","上传中");Erp.FormDataPromise.ajax("http://api.keptrans/image","POST",d,true,c).then(function(e){a.set("uploadStatus","上传完成");a.set("imageUrl","http://keptrans.b0.upaiyun.com"+e.image);console.log(e)},function(e){a.set("startUpload",false);a.set("uploadStatus","上传");a.set("barWidth","width: 0");console.log(e)})}}});Erp.Router.map(function(){this.resource("erp",{path:"/"},function(){this.resource("products",function(){this.route("new")})})});Erp.ErpRoute=Ember.Route.extend({actions:{showSideBar:function(){Ember.$(".ui.sidebar").sidebar({overlay:true}).sidebar("show")},hideSideBar:function(){Ember.$(".ui.sidebar").sidebar({overlay:true}).sidebar("hide")}}});Erp.ProductsNewRoute=Ember.Route.extend({model:function(){return{}}});Erp.ProductsNewController=Ember.ObjectController.extend({formError:false,productError:Ember.A(),isLoading:false,files:Ember.A(),brand:"",tags:Ember.A(),category:"",desc:"",cover:"",rows:Ember.A([{price:"",spec:"",image:"",amount:"",dtime:""}]),reset:false,actions:{publishProduct:function(){var b=this;b.set("formError",false);b.set("productError",Ember.A());var a=this.store.createRecord("product-master",{brand:b.get("brand"),category:b.get("category"),desc:b.get("desc"),tags:b.get("tags")});b.set("isLoading",true);a.save().then(function(c){console.log(c)},function(c){console.log(c)})},uploadImage:function(){$("#upload").trigger("click")},addProduct:function(){var a=this.get("rows");a.pushObject({price:"",spec:"",image:"",amount:"",dtime:""})},removeProduct:function(b){var a=this.get("rows");if(a.length>1){a.removeObject(b)}}}});Erp.ProductIndexController=Ember.ObjectController.extend({selected:false,actions:{select:function(c){var a=this;var b=a.get("selected");if(!b){b={}}Ember.set(b,"selected",false);this.get("rows").forEach(function(d){if(d===c){Ember.set(d,"selected",true);a.set("selected",d)}})},deleteProduct:function(){Ember.$(".ui.modal.remove").modal("show")},confirmDelete:function(){var b=this.get("model");var a=this;b.destroyRecord().then(function(c){var d=Ember.$(".ui.dimmer.page");d.dimmer("show");window.setTimeout(function(){d.dimmer("hide");a.transitionToRoute("products.view")},2000)},function(c){console.log(c)})}}});Erp.ProductEditController=Ember.ObjectController.extend({files:Ember.A(),actions:{removeProduct:function(b){var a=this.get("rows");if(a.length>1){a.removeObject(b)}},addProduct:function(){var a=this.get("rows");a.pushObject({price:"",spec:"",image:""})},updateProduct:function(){var b=this.get("model");var a=this;b.save().then(function(c){var d=Ember.$(".ui.dimmer.page");d.dimmer("show");window.setTimeout(function(){d.dimmer("hide");a.transitionToRoute("product",b)},2000);console.log(c)},function(c){console.log(c)})},uploadImage:function(){$("#upload").trigger("click")},rollback:function(){this.get("model").reload()}}});